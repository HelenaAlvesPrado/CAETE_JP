subroutine wbm5(prec, temp, p0, ca, par,&
     wsoil, gsoil, ssoil,total_runoff, evapm, rcm, emaxm, &
     photo, aresp, npp, lai,&
     clit, csoil, hresp)

  implicit none
  
  !parameters
  integer, parameter :: m = 12
  
  ! i/o

  real, dimension(m), intent(in) :: prec, temp, p0, par
  real, intent(in) :: ca

  real, dimension(m), intent(out) ::  wsoil, gsoil, ssoil, total_runoff, evapm, rcm
  real, dimension(m), intent(out) ::  emaxm, lai, photo, aresp, npp, clit, csoil, hresp
  !real, dimension(m), intent(out) :: 
  !c set some internal variables
  real, dimension(m) :: wg0, spre, tsoil

  integer :: i, k, d, kk, n, nerro
  real :: td, ta, pr, ipar, dwww, rh, wmax, ca1
  real :: wini  = 0.01  !soil moisture initial condition (mm)
  real :: gini  = 0.0   !soil ice initial condition (mm)
  real :: sini  = 0.0   !overland snow initial condition (mm)
   

  real :: wf, gf, sf, runoff, evap, emax,rc2
  real :: ph, ar, nppa, laia, cl, cs, hr, spr

  ca1  = ca *  101.325
  !c initialization
  do k=1,m
     wg0(k) = -1.0
     spre(k) = p0(k) * 0.01 ! converts Pa to mbar
     tsoil(k) = 0.
     wsoil(k) = 0.
     gsoil(k) = 0.
     ssoil(k) = 0.
     total_runoff(k) = 0.
     evapm(k) = 0.
     rcm(k) = 0.
     emaxm(k) = 0.
     lai(k) = 0.
     photo(k) = 0.
     aresp(k) = 0.
     npp(k) = 0.
     clit(k) = 0.
     csoil(k) = 0.
     hresp(k) = 0.
  enddo
  !c
  !c start integration
  call soil_temp(temp, tsoil)
  n = 0
10 continue
  n = n + 1
  !c
  !c pre-processing
  k = mod(n,12)
  if (k.eq.0) k = 12
  
  select case(k)
  case(1)
     d = 31
  case(2)
     d = 28
  case(3)
     d = 31
  case(4)
     d = 30
  case(5)
     d = 31
  case(6)
     d = 30
  case(7)
     d = 31
  case(8)
     d = 31
  case(9)
     d = 30
  case(10)
     d = 31
  case(11)
     d = 30
  case(12)
     d = 31
  end select
  
  td = tsoil(k)
  ta = temp(k)
  pr = prec(k)/real(d)
  ipar = par(k)
  spr = spre(k)
  
  do i=1,d

     runoff = 0.
     evap = 0.
     emax= 0.
     rc2 = 0.
     wf = 0.
     gf = 0.
     sf = 0.
     ph = 0.
     ar = 0.
     nppa = 0.
     laia = 0.
     cl = 0.
     cs = 0.
     hr = 0.
     rh = 0.700
     
     call budget(wini, gini, sini, ta, pr, spr ,rh, ipar, ca1, td,&
          wf, gf, sf, runoff, evap, emax,rc2, &
          ph, ar, nppa, laia,&
          cl, cs, hr)
     
     wsoil(k) = wsoil(k) + (wf / real(d))
     gsoil(k) = gsoil(k) + (gf / real(d))
     ssoil(k) = ssoil(k) + (sf / real(d))
     total_runoff(k) = total_runoff(k) + (runoff / real(d))
     evapm(k) = evapm(k) + (evap / real(d))
     emaxm(k) = emaxm(k) + (emax / real(d))
     rcm(k) = rcm(k) + (rc2/real(d))
     lai(k) = lai(k) + (laia/real(d))
     photo(k) = (photo(k) + (ph / 365.) * 12)
     aresp(k) = (aresp(k) + (ar / 365.) * 12)
     npp(k) = (npp(k) + (nppa / 365.) * 12)
     clit(k) = (clit(k) + (cl / 365.) * 12)
     csoil(k) = (csoil(k) + (cs / 365.) * 12)
     hresp(k) = (hresp(k) + (hr / 365.))
     wini = wf
     gini = gf
     sini = sf

  end do

  
  !c
  !c check if equilibrium is attained (k=12)
  if (k.eq.12) then
     wmax = 500.
     nerro = 0
     do kk=1,12
        dwww = (wsoil(kk)+gsoil(kk)-wg0(kk))/wmax
        if (abs(dwww).gt.0.001) nerro = nerro + 1
     enddo
     if (nerro.ne.0) then
        do kk=1,12
           wg0(kk) = wsoil(kk) + gsoil(kk)
        enddo
     else
        goto 100
     endif
  endif
  goto 10
100 continue
  
end subroutine wbm5
